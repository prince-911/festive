app.py
from flask import Flask, render_template, redirect, url_for, session, request, flash
from flask_mysqldb import MySQL 
from config import Config
from form import LoginForm, RegisterForm, BookingForm
from main import user_login_form, user_register_form, admin_login_form, admin_register_form, book_events, get_admin_data, get_user_data
from flask_wtf.csrf import CSRFProtect

@app.route('/login', methods=['GET', 'POST'])
def login():
    form = LoginForm()
    msg=""

    if form.validate_on_submit():
        role = form.userrole.data
        email = form.email.data
        password = form.password.data

        # Check user credentials
        if role == 'user':
            checkuser = user_login_form(role, email, password)
            checkadmin = admin_login_form(role, email, password)

            if checkuser == "Incorrect":
                flash("Invalid credentials or incorrect password.")
                return redirect(url_for('login'))
            elif checkuser == "No Data":
                flash("No user found. Please register.")
                return redirect(url_for("register"))
            elif checkadmin:
                flash("Admin cannot login as user.")
                return redirect(url_for("login"))
            else:
                # Session should be set here
                session['username'] = checkuser
                session.permanent = True  # Keeps session on page reload
                flash("User login successful")
                return redirect(url_for('index'))  # Redirect to a page after login

        elif role == 'admin':
            checkuser = user_login_form(role, email, password)
            checkadmin = admin_login_form(role, email, password)

            if checkadmin == "Incorrect":
                flash("Invalid credentials or incorrect password.")
                return redirect(url_for('login'))
            elif checkadmin == "No Data":
                flash("No admin found. Please register.")
                return redirect(url_for('register'))
            elif checkuser:
                flash("User cannot login as admin.")
                return redirect(url_for('login'))
            else:
                # Session should be set here
                session['username'] = checkadmin
                session.permanent = True  # Keeps session on page reload
                flash("Admin login successful")
                return redirect(url_for('index'))  # Redirect to a page after login

    # If GET request or invalid POST (form not valid), reset fields only after POST
    if request.method == 'GET':  # After refresh or page reload
        form.email.data = ""
        form.password.data = ""

    return render_template("login.html", res=form)

main.py

import re
import MySQLdb.cursors

def validate_details(email, name, password):
   if not re.fullmatch(r"[^@]+@[^@]+\.[^@]+",email):
       return 1
   if not re.fullmatch(r"^([A-Z][a-z]+)( [A-Z][a-z]+){1,2}$",name) and len(name)>100:
       return 2
   if (len(password)<8 or len(password) > 20 or not re.search(r"[@#$%&_]",password) or
       not re.search(r"[A-Z]",password) or
       not re.search(r"[a-z]",password) or
       not re.search(r"[0-9]",password)):
       return 3
   return 0

    
def get_user_data(name):
   from app import mysql
   con=mysql.connect
   cur=con.cursor(MySQLdb.cursors.DictCursor)
   cur.execute("select name,email from user_details where name=%s",(name,))
   res=cur.fetchone()
   cur.close()
   if res:
      return res
   else:
      return None  

def get_admin_data(name):
   from app import mysql
   con=mysql.connect
   cur=con.cursor(MySQLdb.cursors.DictCursor)
   cur.execute("select name,email from admin_details where name=%s",(name,))
   res=cur.fetchone()
   cur.close()
   if res:
      return res
   else:
      return None     

def user_login_form(userrole,email,password):
   
   from app import mysql
   con=mysql.connect
   cur=con.cursor()
   cur.execute("select name,email,password from user_details where email=%s",(email,))
   res=cur.fetchone()
   cur.close()
   if userrole=='user':
        if res and res['password']==password:
            print("user already exits.Login successfully")
            return res['name']
        elif res and res['password']!=password:
            print("password is not correct")
            return "Incorrect"
        else:
            print("No user found.First register yourself")      
            return "No Data"

def user_register_form(userrole,name,gender,phone,email,password):
   from app import mysql
   con=mysql.connect
   cur=con.cursor()
   cur.execute("select password from user_details where email=%s",(email,)) 
   res=cur.fetchone()
   if userrole=='user':
      if res is None:
        cur.execute("insert into user_details(name,gender,phone,email,password) values(%s,%s,%s,%s,%s)",(name,gender,phone,email,password))
        con.commit()
        cur.close()
        print("User Registration successful")    
        return 0
      elif res:
        print("User Already exists") 
        return 1  

def admin_login_form(userrole,email,password):
   from app import mysql
   con=mysql.connect
   cur=con.cursor()
   cur.execute("select name,email,password from admin_details where email=%s",(email,))
   res=cur.fetchone()
   cur.close()
   if userrole=='admin':
      if res and res['password']==password:
         print("Admin already exits.Login successfully")
         return res['name']
      elif res and res['password']!=password:
         print("password is not correct")
         return "Incorrect"
      else:
         print("No admin found.First register yourself")      
         return "No Data"   

 

def admin_register_form(userrole,name,gender,phone,email,password):
   from app import mysql
   con=mysql.connect
   cur=con.cursor()
   cur.execute("select password from admin_details where email=%s",(email,)) 
   res=cur.fetchone()
   if userrole=='admin':
      if res is None:
        cur.execute("insert into admin_details(name,gender,phone,email,password) values(%s,%s,%s,%s,%s)",(name,gender,phone,email,password))
        con.commit()
        cur.close()
        print(" Admin Registration successful")    
        return 0
      else:
        print("Admin Already exists")     
        return 1
         

def book_events(date,starttime,endtime,location):
   from app import mysql
   con=mysql.connect
   cur=con.cursor()
   cur.execute("Select * from booking_details where starttime=%s and endtime=%s",(starttime,endtime))
   res=cur.fetchone()
   if res is None:
      cur.execute("Insert into booking_details (date,starttime,endtime,location) values(%s,%s,%s,%s)",(date,starttime,endtime,location))
      con.commit()
      cur.close()
      print("Booking successfully.Inserted in table")
      return 0
   else:
      print("Already book.Book another slot")
      return 1

table.sql
drop database if exists `mydb`;
create database `mydb`;
use `mydb`;

drop table if exists `user_details`;
create table `user_details`(
   id int primary key auto_increment,
   name varchar(50) not null,
   gender varchar(10) not null,
   phone int not null unique,
   email varchar(100) unique not null,
   password varchar(100) not null
)Engine=InnoDB;



drop table if exists `admin_details`;
create table `admin_details`(
   id int primary key auto_increment,
   name varchar(50) not null,
   gender varchar(10) not null,
   phone int unique not null,
   email varchar(50) unique not null,
   password varchar(50) not null
)Engine=InnoDB;


drop table if exists `booking_details`;
create table `booking_details`(
   id int primary key auto_increment,
   date date not null,
   starttime time not null,
   endtime time not null,
   location varchar(200) not null
)Engine=InnoDB;



   
